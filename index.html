<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏£‡∏±‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Kanit ‡πÄ‡∏õ‡πá‡∏ô Font ‡∏´‡∏•‡∏±‡∏Å */
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f7f9fb;
        }
        .font-kanit {
            font-family: 'Kanit', sans-serif;
        }
        /* -- PRINT STYLES (for PDF generation) -- */
        @media print {
            /* ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Visible View) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå */
            #view-area { display: none !important; }

            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                position: absolute; 
                left: 0; top: 0; 
                width: 100%; 
                margin: 0;
                padding: 1cm; /* A4 Margin */
            }
            .no-print { display: none !important; }
            .report-table td { page-break-inside: avoid; }
            .report-table h2 { margin-top: 10px !important; }
            .report-table .header-row { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
            .report-table .border-black { border-color: #000 !important; }
            
            /* Print Specific Table Styling */
            .spsr-table td { border-color: #000 !important; padding: 6px; }
            .spsr-table h3 { font-size: 11pt; margin-bottom: 5px; }
            .spsr-table p { margin: 0; font-size: 10pt; }
            /* Force font weight for print notes */
            .spsr-table span[style*="font-weight: normal"] { font-weight: normal; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script> 
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script type="text/babel">
        // ======================================================================
        // START of App.jsx Content (React Components & Logic)
        // ======================================================================

        const { useState, useEffect, useMemo } = React;
        
        // --- 1. FIREBASE CONFIGURATION (MANDATORY) ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyB1ixH1epK4fnaLLbO10wsH_LTDDhraoyg",
            authDomain: "casereportcmo.firebaseapp.com",
            projectId: "casereportcmo",
            storageBucket: "casereportcmo.firebasestorage.app",
            messagingSenderId: "588025239095",
            appId: "1:588025239095:web:9d98aaf31e903546da91b2"
        };
        const FIREBASE_PATH_APP_ID = 'trang-case-system'; 
        
        // --- APPS SCRIPT URLS ---
        const APPS_SCRIPT_RECORD_URL = 'https://script.google.com/macros/s/AKfycbxvb717wxqHcUZVOi8xMSs-ICDa7DydwtDsfwHLMoF-F1V_eeCyI89ZD119uzkP3rifeg/exec'; 
        const APPS_SCRIPT_REFERRAL_URL = 'YOUR_REFERRAL_APPS_SCRIPT_URL_HERE'; 
        
        // --- DRIVE UPLOAD FOLDER URLS ---
        // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏î‡∏¥‡∏°: ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ñ‡∏™ (Original Case Files URL)
        const DRIVE_UPLOAD_CASE_URL = 'https://drive.google.com/drive/u/0/folders/1LXVLw5lorx7lrD4mfbTw39BscTIVdNOd'; 
        // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡∏°‡πà: ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (New Referral Report URL)
        const DRIVE_REFERRAL_UPLOAD_URL = 'https://drive.google.com/drive/u/0/folders/1XO8lG3AWtksKGxb0qBxYtiKilkO5cENM'; 

        // UPDATED: ‡πÉ‡∏ä‡πâ Relative Path ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏à‡πâ‡∏á
        const LOGO_BASE_URL = './head refer form.jpg'; 

        
        // --- Constants ---
        const branchMap = {
            '1': '‡∏™‡∏≤‡∏Ç‡∏≤ 1 ‡∏ô‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏ä‡∏£', '2': '‡∏™‡∏≤‡∏Ç‡∏≤ 2 ‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏á', '3': '‡∏™‡∏≤‡∏Ç‡∏≤ 3 ‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏á',
            '4': '‡∏™‡∏≤‡∏Ç‡∏≤ 4 ‡∏ô‡∏≤‡πÇ‡∏¢‡∏á', '5': '‡∏™‡∏≤‡∏Ç‡∏≤ 5 ‡∏ó‡πà‡∏≤‡∏Å‡∏•‡∏≤‡∏á', '6': '‡∏™‡∏≤‡∏Ç‡∏≤ 6 ‡∏£‡∏±‡∏©‡∏é‡∏≤',
            '7': '‡∏™‡∏≤‡∏Ç‡∏≤ 7 ‡∏£‡∏±‡∏Å‡∏©‡πå‡∏à‡∏±‡∏ô‡∏ó‡∏ô‡πå', '8': '‡∏™‡∏≤‡∏Ç‡∏≤ 8 ‡∏´‡∏ô‡πâ‡∏≤ ‡∏£‡∏£.‡∏™‡∏†‡∏≤‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ', '9': '‡∏™‡∏≤‡∏Ç‡∏≤ 9 ‡∏´‡∏ô‡πâ‡∏≤ ‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡πä'
        };

        const chiefComplaintsOptions = [
            { value: '(01) Dizziness', label: 'Dizziness (‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏®‡∏µ‡∏£‡∏©‡∏∞)' },
            { value: '(02) Headache', label: 'Headache (‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß)' },
            { value: '(03) Pain in joint/muscle pain', label: '‡∏õ‡∏ß‡∏î‡∏Ç‡πâ‡∏≠/‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠' },
            { value: '(04) Toothache', label: 'Toothache (‡∏õ‡∏ß‡∏î‡∏ü‡∏±‡∏ô)' },
            { value: '(05) Abdominal pain (Menstrual)', label: '‡∏õ‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' },
            { value: '(06) Stomachache', label: 'Stomachache (‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á)' },
            { value: '(07) Diarrhea', label: 'Diarrhea (‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢)' },
            { value: '(08) Constipation/Hemorrhoids', label: '‡∏ó‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å/‡∏£‡∏¥‡∏î‡∏™‡∏µ‡∏î‡∏ß‡∏á‡∏ó‡∏ß‡∏≤‡∏£' },
            { value: '(09) Dysuria', label: 'Dysuria (‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÅ‡∏™‡∏ö‡∏Ç‡∏±‡∏î)' },
            { value: '(10) Vaginal discharge', label: 'Vaginal discharge (‡∏ï‡∏Å‡∏Ç‡∏≤‡∏ß)' },
            { value: '(11) Wound', label: 'Wound (‡πÅ‡∏ú‡∏•)' },
            { value: '(12) Skin rash', label: 'Skin rash (‡∏ú‡∏∑‡πà‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á)' },
            { value: '(13) Eye disorder', label: 'Eye disorder (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ï‡∏≤)' },
            { value: '(14) Ear disorder', label: 'Ear disorder (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏´‡∏π)' },
            { value: '(15) Fever/cough/sore throat', label: '‡πÑ‡∏Ç‡πâ ‡πÑ‡∏≠ ‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠' },
            { value: '(16) Covid-19', label: 'Covid-19 (‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏¥‡∏î)' },
            { value: '(17) Rhinorrhea/ nasal congestion', label: '‡∏ô‡πâ‡∏≥‡∏°‡∏π‡∏Å ‡∏Ñ‡∏±‡∏î‡∏à‡∏°‡∏π‡∏Å' },
            { value: '(18) Ulcer in mouth', label: 'Ulcer in mouth (‡πÅ‡∏ú‡∏•‡πÉ‡∏ô‡∏õ‡∏≤‡∏Å)' },
            { value: '(19) Herpes simplex', label: 'Herpes simplex (‡∏ï‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÉ‡∏™‡∏ó‡∏µ‡πà‡∏õ‡∏≤‡∏Å)' },
            { value: '(20) Burn', label: 'Burn (‡πÅ‡∏ú‡∏•‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏•‡∏ß‡∏Å)' },
            { value: '(21) Itchy skin/head', label: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á/‡∏®‡∏µ‡∏£‡∏©‡∏∞' },
            { value: '(22) Helminthiasis', label: 'Helminthiasis (‡∏û‡∏¢‡∏≤‡∏ò‡∏¥)' },
            { value: '(23) Scabies', label: 'Scabies (‡∏´‡∏¥‡∏î ‡πÄ‡∏´‡∏≤)' },
            { value: '(24) Cellulitis', label: 'Cellulitis (‡∏ù‡∏µ ‡∏´‡∏ô‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á)' },
            { value: '(25) Beriberi', label: 'Beriberi (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≤/‡πÄ‡∏´‡∏ô‡πá‡∏ö‡∏ä‡∏≤)' },
            { value: '(26) Insomnia', label: 'Insomnia (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö)' },
            { value: '(27) Motion sickness', label: 'Motion sickness (‡πÄ‡∏°‡∏≤‡∏£‡∏ñ ‡πÄ‡∏°‡∏≤‡πÄ‡∏£‡∏∑‡∏≠)' },
            { value: '(28) Anorexia', label: 'Anorexia (‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£)' },
            { value: '(29) Nausea and vomitting', label: '‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏™‡πâ ‡∏≠‡∏≤‡πÄ‡∏à‡∏µ‡∏¢‡∏ô' },
            { value: '(30) Drug/food allergy/insect bite', label: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤/‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÅ‡∏°‡∏•‡∏á‡∏Å‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏¢' },
            { value: '(31) Tobacco dependence', label: '‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà' },
            { value: '(32) Gingivitis', label: '‡πÄ‡∏´‡∏á‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö/‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏õ‡∏≤‡∏Å' },
        ];
        
        // --- Utility Functions (using compat syntax) ---
        const getFirestoreCompat = () => firebase.firestore();
        const getAuthCompat = () => firebase.auth();
        const getCollectionCompat = (db, ...path) => db.collection(path.join('/'));
        const getDocCompat = (db, ...path) => db.doc(path.join('/'));
        const serverTimestampCompat = firebase.firestore.FieldValue.serverTimestamp;

        // --- Loading Component ---
        const LoadingSpinner = () => (
            <div className="flex justify-center items-center p-12">
                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
                <p className="ml-4 text-indigo-700 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
            </div>
        );
        
        // ======================================================================
        // 2. FIREBASE HOOKS & CONTEXT
        // ======================================================================

        const defaultFormData = {
            branch: '1', reporter: '', patient_name: '', tel: '', age: '', weight: '', height: '',
            chronic_disease: '', drug_allergy: '', chief_complaints: [], history: '', diagnosis: '',
            treatment: '', follow_up_date: '', follow_up_result: '', status: '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°',
        };

        const useFirebase = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                if (!USER_FIREBASE_CONFIG.apiKey || USER_FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
                    setIsAuthReady(true);
                    return;
                }

                try {
                    firebase.initializeApp(USER_FIREBASE_CONFIG);
                    const firestore = getFirestoreCompat();
                    const authInstance = getAuthCompat();
                    setDb(firestore);
                    setAuth(authInstance);

                    const unsubscribe = authInstance.onAuthStateChanged(async (user) => {
                        if (!user) {
                            await authInstance.signInAnonymously();
                        }
                        setUserId(authInstance.currentUser.uid);
                        setIsAuthReady(true);
                    });

                    return () => unsubscribe();
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    setIsAuthReady(true);
                }
            }, []);

            return { db, auth, userId, isAuthReady };
        };

        const useCaseData = (db, isAuthReady) => {
            const [cases, setCases] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db || !isAuthReady || !db.collection) return;

                const caseCollectionRef = getCollectionCompat(db, 'artifacts', FIREBASE_PATH_APP_ID, 'public/data/cases');
                
                const unsubscribe = caseCollectionRef.orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                    const caseList = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            timestamp: data.timestamp?.toDate ? data.timestamp.toDate().toLocaleDateString('th-TH') : 'N/A',
                        };
                    });
                    setCases(caseList);
                    setLoading(false);
                }, (error) => {
                    console.error("Firestore error:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, isAuthReady]);

            return { cases, loading };
        };

        // --- F. Footer Component ---
        const Footer = () => {
            const [currentTime, setCurrentTime] = useState(new Date());

            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            const formattedTime = currentTime.toLocaleDateString('th-TH', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: false
            });

            return (
                <footer className="mt-12 py-4 border-t no-print bg-white shadow-inner">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between items-center text-gray-500 text-sm">
                        
                        {/* Main Footer Text (Left/Center) */}
                        <div className="text-center sm:text-left mb-1 sm:mb-0">
                            CMO-Case Management System (Powered by React &amp; Firebase) 
                            <span className="font-semibold text-gray-700 ml-2 block sm:inline">
                                | {formattedTime}
                            </span>
                        </div>
                        
                        {/* Credit (Bottom Right) */}
                        <div className="text-[10px] text-gray-400 opacity-80 mt-1 sm:mt-0">
                            Develop by Opioid.Apisit
                        </div>
                    </div>
                </footer>
            );
        };


        // ======================================================================
        // 3. COMPONENTS
        // ======================================================================

        // Helper function to render the core body of the Referral Report (PhRF)
        const renderReportBody = (caseData, getCurrentDate, treatmentBoxChecked, elementId) => (
            <div id={elementId} className="p-8 font-kanit text-gray-900 bg-white" style={{ maxWidth: '210mm', margin: '0 auto', fontSize: '10pt', border: 'none' }}>
                            
                {/* --- HEADER ROW (Logos) --- */}
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '5px' }}>
                    <img src={LOGO_BASE_URL} alt="Header Logos" style={{ height: 'auto', maxHeight: '40px', display: 'block' }} 
                        onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/100x40/eeeeee/333333?text=Logo+Missing"; }} />
                    
                    <div style={{ fontSize: '10pt', paddingBottom: '0' }}>
                        <strong>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> {caseData.cid || '...........................................'}
                    </div>
                </div>
                
                {/* UPDATED: ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å */}
                <h2 className="text-lg font-bold text-center mb-2" style={{fontSize: '14pt', margin: '10px 0 15px 0', borderBottom: '1px solid #000', paddingBottom: '5px'}}>
                    ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Pharmacist Referral Form: PhRF)
                </h2>

                {/* --- MAIN INFO TABLE (SPSR Layout) --- */}
                <table className="w-full spsr-table border-collapse border border-gray-900 text-sm" style={{ tableLayout: 'fixed' }}>
                    <tbody>
                        {/* Row 1: Patient Name / Gender / Age */}
                        <tr>
                            <td colSpan="4" className="border border-gray-900 p-2" style={{ lineHeight: '1.4' }}>
                                <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</strong> {caseData.patient_name || '...................................................'} | 
                                <strong>‡πÄ‡∏û‡∏®:</strong> {caseData.gender || '........'} | 
                                <strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> {caseData.age || '......'} ‡∏õ‡∏µ |
                                <strong>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> {caseData.tel || '..............................'}
                            </td>
                        </tr>
                        {/* Row 2: Address / Scheme / Reason */}
                        <tr>
                            <td colSpan="4" className="border border-gray-900 p-2" style={{ lineHeight: '1.4' }}>
                                <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> {caseData.address || '...............................................................................................................'} </p>
                                <p><strong>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•:</strong> {caseData.health_scheme || '.........................................'} | 
                                <strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠:</strong> {caseData.reason_for_referral || '...............................................................'}
                                </p>
                            </td>
                        </tr>

                        {/* SECTION 2: Assessment/Details Header */}
                        <tr>
                            <td colSpan="2" className="border border-gray-900 p-2 font-bold header-row" style={{ backgroundColor: '#f0f0f0', textAlign: 'center', fontWeight: 'bold' }}>
                                ‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
                            </td>
                            <td colSpan="2" className="border border-gray-900 p-2 font-bold header-row" style={{ backgroundColor: '#f0f0f0', textAlign: 'center', fontWeight: 'bold' }}>
                                ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
                            </td>
                        </tr>
                        <tr>
                            {/* Left Column: Drug Review */}
                            <td colSpan="2" className="border border-gray-900 p-2 align-top h-40">
                                <div style={{ whiteSpace: 'pre-wrap' }}>{caseData.drug_review || ' - '}</div>
                            </td>
                            {/* Right Column: Details */}
                            <td colSpan="2" className="border border-gray-900 p-2 align-top">
                                <p><strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> {caseData.chief_complaints || '-'}</p>
                                <p><strong>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢:</strong> {caseData.history_of_illness || '-'}</p>
                                <p><strong>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</strong> {caseData.chronic_disease || '-'}</p>
                                <p><strong>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</strong> {caseData.drug_allergy || '-'}</p>
                                <p><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</strong> {caseData.additional_info || '-'}</p>
                                <p><strong>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:</strong> {caseData.problem_found || '-'}</p>
                            </td>
                        </tr>

                        {/* SECTION 3: Initial Action Header */}
                        <tr>
                            <td colSpan="4" className="border border-gray-900 p-2 font-bold header-row" style={{ backgroundColor: '#f0f0f0', textAlign: 'center', fontWeight: 'bold' }}>
                                ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£
                            </td>
                        </tr>
                        <tr>
                            {/* MODIFIED: ‡πÅ‡∏™‡∏î‡∏á Note ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å Checkbox */}
                            <td colSpan="4" className="border border-gray-900 p-2 align-top" style={{ lineHeight: '1.8' }}>
                                {/* 1. ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô + Note */}
                                <p>
                                    [{treatmentBoxChecked('give_treatment')}] ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
                                    {caseData.initial_treatment.includes('give_treatment') && caseData.treatment_note && (
                                        <span style={{ display: 'inline-block', marginLeft: '10px', fontWeight: 'normal' }}>
                                            **‡∏£‡∏∞‡∏ö‡∏∏: {caseData.treatment_note}**
                                        </span>
                                    )}
                                </p>

                                {/* 2. ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ + Note */}
                                <p>
                                    [{treatmentBoxChecked('give_advice')}] ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤/‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
                                    {caseData.initial_treatment.includes('give_advice') && caseData.advice_note && (
                                        <span style={{ display: 'inline-block', marginLeft: '10px', fontWeight: 'normal' }}>
                                            **‡∏£‡∏∞‡∏ö‡∏∏: {caseData.advice_note}**
                                        </span>
                                    )}
                                </p>
                                
                                {/* 3. ‡∏≠‡∏∑‡πà‡∏ô‡πÜ + Note */}
                                <p>
                                    [{treatmentBoxChecked('other_action')}] ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                                    {caseData.initial_treatment.includes('other_action') && caseData.other_note && (
                                        <span style={{ display: 'inline-block', marginLeft: '10px', fontWeight: 'normal' }}>
                                            **‡∏£‡∏∞‡∏ö‡∏∏: {caseData.other_note}**
                                        </span>
                                    )}
                                </p>
                            </td>
                        </tr>
                        
                        {/* Signature / Footer */}
                        <tr>
                            <td colSpan="4" className="p-4 pt-8 border-gray-900 text-right" style={{ borderTop: 'none', borderBottom: 'none' }}>
                                <div style={{ textAlign: 'center', marginTop: '30px', marginBottom: '10px', fontSize: '10pt' }}>
                                    <p>(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠) .....................................................</p>
                                    <p style={{marginTop: '5px'}}>‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠: {caseData.pharmacist_name || '...........................................'} </p>
                                    <p>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û: {caseData.license_no || '...........................................'} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {getCurrentDate()}</p>
                                </div>
                                <div style={{ textAlign: 'left', borderTop: '1px solid #ccc', paddingTop: '10px', marginTop: '15px', fontSize: '10pt' }}>
                                    <p><strong>‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤:</strong> {caseData.pharmacy_name || '-'} | 
                                    <strong>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> {caseData.pharmacy_tel || '-'}
                                    </p>
                                    <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤:</strong> {caseData.pharmacy_address || '-'} </p>
                                </div>
                            </td>
                        </tr>
                        
                        {/* Bottom Section for Hospital (Blank space) */}
                        <tr>
                            <td colSpan="4" className="p-2 border border-gray-900 header-row" style={{fontSize: '10pt', backgroundColor: '#f0f0f0', textAlign: 'center'}}>
                                <p> ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô </p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
            </div>
        );


        // --- I. Referral Print View (SPSR Template - NEW) ---
        const ReferralPrintView = ({ caseData, onEdit, onFinalize }) => {
            
            const getCurrentDate = () => new Date().toLocaleDateString('th-TH', { day: 'numeric', month: 'numeric', year: 'numeric' });
            
            // MODIFIED: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ X ‡πÄ‡∏õ‡πá‡∏ô ‚úì
            const treatmentBoxChecked = (name) => caseData.initial_treatment.includes(name) ? '‚úì' : ''; 
            
            // Render the print controls and the print area
            return (
                <div className="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8 font-kanit">

                    <h2 className="text-2xl font-bold text-gray-800 mb-6 no-print">
                        ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå: ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (PhRF)
                    </h2>
                    
                    {/* 1. Visible Report Content (Takes up visual space in the flow) */}
                    <div id="view-area" className="no-print bg-white rounded-xl shadow-lg mb-8">
                        {renderReportBody(caseData, getCurrentDate, treatmentBoxChecked, 'view-area-content')}
                    </div>
                    
                    {/* 2. Control Panel (Now clearly below the visible report content) */}
                    <div className="flex justify-between items-center bg-yellow-50 p-4 rounded-xl shadow-md mt-8 no-print border border-yellow-200">
                        <button onClick={onEdit}
                                className="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out flex items-center">
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"></path></svg>
                            ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>

                        <button onClick={onFinalize}
                                className="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out flex items-center">
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 17h2v5H3v-5h2M17 9l-5 5-5-5M12 12V3"></path></svg>
                            ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
                        </button>
                    </div>

                    {/* 3. Printable Report Content (Hidden on screen, exported via portal) */}
                    {ReactDOM.createPortal(
                        renderReportBody(caseData, getCurrentDate, treatmentBoxChecked, 'print-area'),
                        document.body
                    )}

                </div>
            );
        };


        // --- H. Referral Form Component (SPSR Report) ---
        const ReferralForm = ({ initialData, onCancel, onSendReport }) => {
            // Use initialData passed from parent (which holds incomplete referral data from print preview)
            const [formData, setFormData] = useState(initialData || {
                pharmacy_name: '‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠', 
                pharmacy_address: '', 
                pharmacy_tel: '', 
                pharmacist_name: '',
                license_no: '',
                
                patient_name: '',
                cid: '',
                gender: '‡∏ä‡∏≤‡∏¢',
                age: '',
                address: '',
                tel: '',
                health_scheme: 'UC',
                reason_for_referral: 'further investigation/management',
                
                drug_review: '',
                chief_complaints: '',
                history_of_illness: '',
                chronic_disease: '',
                drug_allergy: '',
                additional_info: '',
                problem_found: '',

                // Checkboxes for initial action
                initial_treatment: [],
                treatment_note: '',
                advice_note: '',
                other_note: ''
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isEditMode = initialData != null; // Check if it's being edited from print view

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                
                if (type === 'checkbox') {
                    setFormData(prev => {
                        const updated = checked
                            ? [...new Set([...prev.initial_treatment, name])]
                            : prev.initial_treatment.filter(n => n !== name);
                        return { ...prev, initial_treatment: updated };
                    });
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                // FIX: Check for patient_name and pharmacist_name
                if (!formData.patient_name || !formData.pharmacist_name) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠');
                    return;
                }
                setIsSubmitting(true);
                
                // IMPORTANT: The submission now only prepares data and shows print preview
                onSendReport(formData, 'referral') 
                    .finally(() => setIsSubmitting(false)); // Finalize is handled by the print view
            };

            return (
                <main className="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                    {/* --- Back Button --- */}
                    <button onClick={onCancel}
                            className="text-indigo-600 hover:text-indigo-800 text-sm font-semibold flex items-center mb-4">
                        <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                    
                    <div className="bg-white p-8 rounded-xl shadow-lg">
                        <h1 className="text-2xl font-semibold text-gray-900 mb-6 border-b pb-2">
                            ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏™‡∏õ‡∏™‡∏ä.) {isEditMode ? '(‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)' : ''}
                        </h1>
                        
                        <form onSubmit={handleSubmit}>
                            {/* --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2 mt-6">‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</label>
                                    <input type="text" name="pharmacist_name" value={formData.pharmacist_name} onChange={handleChange} required
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤</label>
                                    <input type="text" name="pharmacy_name" value={formData.pharmacy_name} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û</label>
                                    <input type="text" name="license_no" value={formData.license_no} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤</label>
                                    <input type="tel" name="pharmacy_tel" value={formData.pharmacy_tel} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤</label>
                                    <textarea name="pharmacy_address" rows="2" value={formData.pharmacy_address} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                </div>
                                
                            </div>

                            {/* --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2 mt-6">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="md:col-span-3">
                                    <label className="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                                    <input type="text" name="patient_name" value={formData.patient_name} onChange={handleChange} required
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                                    <input type="text" name="cid" value={formData.cid} onChange={handleChange} maxLength="13"
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡πÄ‡∏û‡∏®</label>
                                    <select name="gender" value={formData.gender} onChange={handleChange}
                                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5">
                                        <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
                                        <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
                                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏≠‡∏≤‡∏¢‡∏∏</label>
                                    <input type="number" name="age" value={formData.age} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                                    <input type="text" name="address" value={formData.address} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                    <input type="tel" name="tel" value={formData.tel} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                </div>
                                
                                <div className="md:col-span-3">
                                    <label className="block text-sm font-medium text-gray-700">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                                    <select name="health_scheme" value={formData.health_scheme} onChange={handleChange}
                                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5">
                                        <option value="UC">UC</option>
                                        <option value="‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£">‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</option>
                                        <option value="‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°</option>
                                    </select>
                                </div>

                                <div className="md:col-span-3">
                                    <label className="block text-sm font-medium text-gray-700">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</label>
                                    <select name="reason_for_referral" value={formData.reason_for_referral} onChange={handleChange}
                                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5">
                                        <option value="further investigation/management">further investigation/management</option>
                                        <option value="Drug-related problem">Drug-related problem</option>
                                        <option value="Loss of follow-up">Loss of follow-up</option>
                                    </select>
                                </div>
                            </div>
                            
                            {/* --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2 mt-6">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</h2>
                            <div className="grid grid-cols-1 gap-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</label>
                                    <textarea name="drug_review" rows="2" value={formData.drug_review} onChange={handleChange}
                                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"></textarea>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
                                    <textarea name="chief_complaints" rows="2" value={formData.chief_complaints} onChange={handleChange} required
                                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"></textarea>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢</label>
                                    <textarea name="history_of_illness" rows="3" value={formData.history_of_illness} onChange={handleChange}
                                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"></textarea>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                                        <input type="text" name="chronic_disease" value={formData.chronic_disease} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
                                        <input type="text" name="drug_allergy" value={formData.drug_allergy} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"/>
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                                    <textarea name="additional_info" rows="2" value={formData.additional_info} onChange={handleChange}
                                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"></textarea>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö</label>
                                    <textarea name="problem_found" rows="2" value={formData.problem_found} onChange={handleChange}
                                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"></textarea>
                                </div>
                            </div>

                            {/* --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (Checkboxes) --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2 mt-6">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h2>
                            <div className="grid grid-cols-1 gap-4 mb-6 bg-gray-50 p-4 rounded-md">
                                {/* Checkbox 1 */}
                                <div className="flex items-start">
                                    <input type="checkbox" name="give_treatment" checked={formData.initial_treatment.includes('give_treatment')} onChange={handleChange}
                                           className="mt-1 rounded text-indigo-600 focus:ring-indigo-500 h-4 w-4 mr-3"/>
                                    <div className="flex-grow">
                                        <label className="block text-sm font-medium text-gray-700">‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</label>
                                        <textarea name="treatment_note" rows="1" value={formData.treatment_note} onChange={handleChange} placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤..."
                                                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-sm"/>
                                    </div>
                                </div>
                                {/* Checkbox 2 */}
                                <div className="flex items-start">
                                    <input type="checkbox" name="give_advice" checked={formData.initial_treatment.includes('give_advice')} onChange={handleChange}
                                           className="mt-1 rounded text-indigo-600 focus:ring-indigo-500 h-4 w-4 mr-3"/>
                                    <div className="flex-grow">
                                        <label className="block text-sm font-medium text-gray-700">‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤/‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</label>
                                        <textarea name="advice_note" rows="1" value={formData.advice_note} onChange={handleChange} placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥..."
                                                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-sm"/>
                                    </div>
                                </div>
                                {/* Checkbox 3 */}
                                <div className="flex items-start">
                                    <input type="checkbox" name="other_action" checked={formData.initial_treatment.includes('other_action')} onChange={handleChange}
                                           className="mt-1 rounded text-indigo-600 focus:ring-indigo-500 h-4 w-4 mr-3"/>
                                    <div className="flex-grow">
                                        <label className="block text-sm font-medium text-gray-700">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                                        <textarea name="other_note" rows="1" value={formData.other_note} onChange={handleChange} placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ..."
                                                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-sm"/>
                                    </div>
                                </div>
                            </div>

                            {/* --- Action Button --- */}
                            <button type="submit" 
                                    disabled={isSubmitting}
                                    className={`w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out mt-6 ${isSubmitting ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                <span className="text-lg">üñ®Ô∏è</span> {isSubmitting ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...' : '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠)'}
                            </button>
                        </form>
                    </div>
                </main>
            );
        };

        // (Case Print View, Case Form and Dashboard components remain unchanged for brevity)

        // --- G. Case Print View (Standard Report) ---
        // RENAMED ReportPrintView to StandardReportPrintView to fix redeclaration error.
        const StandardReportPrintView = ({ caseData, onHide, onPostPrint }) => {
            
            // This component is used for printing the standard case report (from the CaseForm)
            useEffect(() => {
                const timer = setTimeout(() => {
                    window.print();
                    onPostPrint(); 
                    onHide();      
                }, 500);
                return () => clearTimeout(timer);
            }, [onHide, onPostPrint]);

            const formatDate = (dateString) => {
                if (!dateString) return '-';
                try {
                    return new Date(dateString + 'T00:00:00').toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
                } catch (e) {
                    return dateString;
                }
            };
            
            const chiefComplaintsText = (Array.isArray(caseData.chief_complaints) 
                ? caseData.chief_complaints.join('\n') 
                : caseData.chief_complaints?.replace(/; /g, '\n')) || ' - ';


            return ReactDOM.createPortal(
                <div id="print-area" className="p-8 font-kanit text-gray-900 bg-white" style={{ maxWidth: '210mm', margin: '0 auto' }}>
                    
                    <h1 className="text-xl font-bold text-center mb-4">
                        ‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠)
                    </h1>
                    
                    <table className="w-full report-table border-collapse border border-gray-500 text-sm">
                        {/* Section 1: Header */}
                        <thead>
                            <tr className="bg-gray-100">
                                <td colSpan="2" className="p-2 border border-gray-500 font-semibold">
                                    ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: {branchMap[caseData.branch]}
                                </td>
                                <td colSpan="2" className="p-2 border border-gray-500 font-semibold">
                                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: {caseData.timestamp}
                                </td>
                            </tr>
                            <tr className="bg-blue-50">
                                <td colSpan="4" className="p-2 border border-gray-500 font-bold">
                                    ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                                </td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colSpan="2" className="p-2 border border-gray-500">
                                    ‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•: {caseData.patient_name}
                                </td>
                                <td colSpan="2" className="p-2 border border-gray-500">
                                    ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: {caseData.tel || '-'}
                                </td>
                            </tr>
                            <tr>
                                <td className="p-2 border border-gray-500" style={{width: '25%'}}>
                                    ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: {caseData.weight || '-'} ‡∏Å‡∏Å.
                                </td>
                                <td className="p-2 border border-gray-500" style={{width: '25%'}}>
                                    ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á: {caseData.height || '-'} ‡∏ã‡∏°.
                                </td>
                                <td colSpan="2" className="p-2 border border-gray-500">
                                    ‡∏≠‡∏≤‡∏¢‡∏∏: {caseData.age || '-'} ‡∏õ‡∏µ
                                </td>
                            </tr>
                            <tr>
                                <td colSpan="4" className="p-2 border border-gray-500">
                                    ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: {caseData.chronic_disease || '-'}
                                </td>
                            </tr>
                            <tr>
                                <td colSpan="4" className="p-2 border border-gray-500">
                                    ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤: {caseData.drug_allergy || '-'}
                                </td>
                            </tr>

                            {/* Section 2: Treatment */}
                            <tr className="bg-blue-50">
                                <td colSpan="4" className="p-2 border border-gray-500 font-bold">
                                    ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤
                                </td>
                            </tr>
                            <tr>
                                <td colSpan="4" className="p-2 border border-gray-500 h-20 align-top">
                                    <span className="font-semibold">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</span> 
                                    <div style={{ whiteSpace: 'pre-wrap' }}>{chiefComplaintsText}</div>
                                </td>
                            </tr>
                            <tr>
                                <td colSpan="4" className="p-2 border border-gray-500 h-20 align-top">
                                    <span className="font-semibold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:</span> 
                                    <div className="whitespace-pre-wrap">{caseData.history || '-'}</div>
                                </td>
                            </tr>
                            <tr>
                                <td colSpan="4" className="p-2 border border-gray-500">
                                    <span className="font-semibold">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:</span> 
                                    <div>{caseData.diagnosis || '-'}</div>
                                </td>
                            </tr>
                            <tr>
                                <td colSpan="4" className="p-2 border border-gray-500 h-20 align-top">
                                    <span className="font-semibold">‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏¢‡∏≤):</span> 
                                    <div className="whitespace-pre-wrap">{caseData.treatment || '-'}</div>
                                </td>
                            </tr>

                            {/* Section 3: Follow Up */}
                            <tr className="bg-blue-50">
                                <td colSpan="4" className="p-2 border border-gray-500 font-bold">
                                    ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
                                </td>
                            </tr>
                            <tr>
                                <td colSpan="4" className="p-2 border border-gray-500">
                                    <span className="font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°:</span> {formatDate(caseData.follow_up_date)}
                                </td>
                            </tr>
                            <tr>
                                <td colSpan="4" className="p-2 border border-gray-500 h-20 align-top">
                                    <span className="font-semibold">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°:</span> 
                                    <div className="whitespace-pre-wrap">{caseData.follow_up_result || '-'}</div>
                                </td>
                            </tr>
                            
                            {/* Signature Line */}
                            <tr>
                                <td colSpan="4" className="p-4 text-right">
                                    <p className="mt-8">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠..................................................</p>
                                    <p>(‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£/‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                </div>,
                document.body
            );
        };


        // --- A. Case Report Form Component (UNMODIFIED FOR BREVITY) ---
        const CaseForm = ({ initialCase = null, onSave, onCancel, onDelete }) => {
            const initialData = initialCase ? initialCase : defaultFormData;
                
            const [formData, setFormData] = useState(initialData);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isEditMode = initialCase !== null;

            // --- Handler for "Back to Dashboard" button ---
            const handleBackToDashboard = (e) => {
                e.preventDefault();
                onCancel();
            };

            useEffect(() => {
                if (isEditMode) {
                    const complaints = typeof initialCase.chief_complaints === 'string' 
                        ? initialCase.chief_complaints.split('; ').filter(Boolean)
                        : initialCase.chief_complaints || [];
                    
                    setFormData({
                        ...initialCase,
                        chief_complaints: complaints
                    });
                } else {
                    setFormData(defaultFormData);
                }
            }, [initialCase, isEditMode]);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                
                if (type === 'checkbox') {
                    setFormData(prev => {
                        const updatedComplaints = checked
                            ? [...new Set([...prev.chief_complaints, value])]
                            : prev.chief_complaints.filter(c => c !== value);
                        return { ...prev, chief_complaints: updatedComplaints };
                    });
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleSubmit = (e, newStatus = null, shouldDelete = false) => {
                e.preventDefault();
                
                if (!formData.patient_name || !formData.branch || !formData.reporter || formData.chief_complaints.length === 0) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢, ‡∏™‡∏≤‡∏Ç‡∏≤, ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç');
                    return;
                }
                
                if (shouldDelete) {
                    onDelete(formData.id);
                    return;
                }
                
                if (isSubmitting) return;
                setIsSubmitting(true);

                const finalData = {
                    ...formData,
                    chief_complaints: Array.isArray(formData.chief_complaints) ? formData.chief_complaints.join('; ') : formData.chiefComplaints,
                    status: newStatus || formData.status,
                };
                
                if (newStatus === '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß') {
                    // Ask for print confirmation
                    const confirmPrint = confirm("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF)");
                    
                    // If confirmed, save to Firebase and trigger print
                    onSave(finalData, isEditMode, confirmPrint);
                } else {
                    onSave(finalData, isEditMode);
                    setIsSubmitting(false);
                }
            };

            return (
                <main className="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                    {/* --- New Back Button --- */}
                    <button onClick={handleBackToDashboard}
                            className="text-indigo-600 hover:text-indigo-800 text-sm font-semibold flex items-center mb-4">
                        <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                    {/* --- End New Back Button --- */}

                    <div className="bg-white p-8 rounded-xl shadow-lg">
                        <h1 className="text-2xl font-semibold text-gray-900 mb-6 border-b pb-2">
                            {isEditMode ? `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ñ‡∏™: ${formData.patient_name}` : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà'}
                        </h1>
                        
                        <form> 
                            {/* --- 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2 mt-6">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô <span className="text-red-500">*</span></label>
                                    <select name="branch" value={formData.branch} onChange={handleChange} required
                                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                                        {Object.keys(branchMap).map(id => (
                                            <option key={id} value={id}>{branchMap[id]}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô <span className="text-red-500">*</span></label>
                                    <input type="text" name="reporter" value={formData.reporter} onChange={handleChange} required
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                            </div>

                            {/* --- 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div className="md:col-span-3">
                                    <label className="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ <span className="text-red-500">*</span></label>
                                    <input type="text" name="patient_name" value={formData.patient_name} onChange={handleChange} required
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                    <input type="tel" name="tel" value={formData.tel} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏≠‡∏≤‡∏¢‡∏∏</label>
                                    <input type="number" name="age" value={formData.age} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
                                    <input type="number" name="weight" value={formData.weight} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label>
                                    <input type="number" name="height" value={formData.height} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                                    <input type="text" name="chronic_disease" value={formData.chronic_disease} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
                                    <input type="text" name="drug_allergy" value={formData.drug_allergy} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                            </div>
                            
                            {/* --- 3. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2 mt-6">3. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>
                            <div className="grid grid-cols-1 gap-6 mb-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1) <span className="text-red-500">*</span></label>
                                    <div id="chief-complaints-list" className="bg-gray-50 p-4 rounded-md border border-gray-300 h-64 overflow-y-auto">
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-2 gap-x-4">
                                            {chiefComplaintsOptions.map(option => (
                                                <div key={option.value} className="flex items-center">
                                                    <input 
                                                        type="checkbox" 
                                                        name="chief_complaints" 
                                                        value={option.value} 
                                                        checked={formData.chief_complaints.includes(option.value)}
                                                        onChange={handleChange}
                                                        className="rounded text-indigo-600 focus:ring-indigo-500 h-4 w-4 mr-2"
                                                    />
                                                    <span className="text-sm text-gray-800">{option.label}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</label>
                                    <textarea name="history" rows="3" value={formData.history} onChange={handleChange}
                                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢</label>
                                    <input type="text" name="diagnosis" value={formData.diagnosis} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                                    <textarea name="treatment" rows="3" value={formData.treatment} onChange={handleChange}
                                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                                </div>
                            </div>

                            {/* --- 4. ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ --- */}
                            <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2 mt-6">4. ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label>
                                    <input type="date" name="follow_up_date" value={formData.follow_up_date} onChange={handleChange}
                                           className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"/>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢)</label>
                                    <textarea name="follow_up_result" rows="2" value={formData.follow_up_result} onChange={handleChange}
                                              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                                </div>
                            </div>


                            {/* --- Action Buttons --- */}
                            <div className="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 pt-4 border-t mt-8">
                                
                                {/* 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏™ (‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°) */}
                                <button type="button" onClick={(e) => handleSubmit(e, '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°')}
                                        disabled={isSubmitting}
                                        className={`flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out ${isSubmitting ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                    <span className="text-lg">üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏û‡∏±‡∏Å‡πÄ‡∏Ñ‡∏™ (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°)
                                </button>

                                {/* 2. ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ (‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß) - PRINT FLOW (CORS-FREE) */}
                                <button type="button" onClick={(e) => handleSubmit(e, '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß')}
                                        disabled={isSubmitting}
                                        className={`flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out ${isSubmitting ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                    <span className="text-lg">üñ®Ô∏è</span> ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ &amp; ‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Print)
                                </button>
                                
                                {/* 3. ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™ */}
                                {isEditMode ? (
                                     <button type="button" onClick={(e) => handleSubmit(e, null, true)}
                                        disabled={isSubmitting}
                                        className={`flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out ${isSubmitting ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                        <span className="text-lg">üóëÔ∏è</span> ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™
                                     </button>
                                ) : (
                                     <button type="button" onClick={onCancel}
                                        disabled={isSubmitting}
                                        className={`flex-1 bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out ${isSubmitting ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                        <span className="text-lg">‚ùå</span> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å)
                                     </button>
                                )}
                            </div>
                        </form>
                    </div>
                </main>
            );
        };


        // --- D. Dashboard Component (UNMODIFIED FOR BREVITY) ---
        const Dashboard = ({ cases, loading, onAddCase, onEditCase, onReport }) => {
            
            const [searchTerm, setSearchTerm] = useState('');
            const [branchFilter, setBranchFilter] = useState(''); 

            const filteredAndSortedCases = useMemo(() => {
                const lowerCaseSearch = searchTerm.toLowerCase();
                
                let filtered = cases.filter(c => 
                    c.patient_name.toLowerCase().includes(lowerCaseSearch) ||
                    (c.tel && c.tel.includes(searchTerm))
                );

                // Apply Branch Filter (If branchFilter is set, filter by branch ID)
                if (branchFilter) {
                    filtered = filtered.filter(c => c.branch === branchFilter);
                }

                return [...filtered].sort((a, b) => {
                    // Always show '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' first
                    if (a.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' && b.status !== '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°') return -1;
                    if (a.status !== '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' && b.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°') return 1;
                    return (b.timestamp || '').localeCompare(a.timestamp || ''); 
                });
            }, [cases, searchTerm, branchFilter]);

            const pendingCount = filteredAndSortedCases.filter(c => c.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°').length;

            if (loading) {
                return <LoadingSpinner />;
            }

            return (
                <main className="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                    <h2 className="text-2xl font-bold mb-4 text-gray-800">
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </h2>

                    {/* Header and Action Buttons (UPDATED NAME AND EMOJIS) */}
                    <div className="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mb-8">
                        {/* 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà (#a3e9a4 ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) */}
                        <button onClick={onAddCase}
                                className="flex-1 bg-[#a3e9a4] hover:bg-emerald-500 text-gray-900 font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-150 ease-in-out">
                            <span className="text-xl mr-2">‚ûï</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà
                        </button>
                        
                        {/* 2. ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ñ‡∏™ (#ECD4D4 ‡∏û‡∏µ‡∏ä) */}
                        <a href={DRIVE_UPLOAD_CASE_URL} target="_blank" rel="noopener noreferrer"
                                className="flex-1 bg-[#ECD4D4] hover:bg-rose-400 text-gray-900 font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-150 ease-in-out text-center flex items-center justify-center">
                            <span className="text-lg mr-2">üìÑ</span> Up ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏™
                        </a>
                        
                        {/* 3. ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (#b3e5fc ‡∏ü‡πâ‡∏≤) */}
                        <button onClick={() => onReport('referral')} // Change View to Referral Form
                                className="flex-1 bg-[#b3e5fc] hover:bg-sky-500 text-gray-900 font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-150 ease-in-out">
                            <span className="text-lg mr-2">üè•</span> ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                        </button>
                        
                        {/* 4. ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (#ffe0b2 ‡∏™‡πâ‡∏°) */}
                        <a href={DRIVE_REFERRAL_UPLOAD_URL} target="_blank" rel="noopener noreferrer"
                                className="flex-1 bg-[#ffe0b2] hover:bg-orange-300 text-gray-900 font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-150 ease-in-out text-center flex items-center justify-center">
                            <span className="text-lg mr-2">üìÑ</span> Up ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                        </a>

                        {/* 5. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå (Keep Neutral Gray) */}
                        <button onClick={() => alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ADR ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤ ‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á')}
                                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out">
                            <span className="text-lg mr-2">üòµ</span> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ADR
                        </button>
                    </div>

                    {/* Search and Filter Bar */}
                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <div className="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">
                            {/* 1. Search Text Input */}
                            <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠, ‡∏™‡∏Å‡∏∏‡∏•, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå..."
                                   value={searchTerm}
                                   onChange={(e) => setSearchTerm(e.target.value)}
                                   className="flex-grow border border-gray-300 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500 text-lg"/>

                            {/* 2. Branch Filter Dropdown (NEW) */}
                            <select name="branchFilter" value={branchFilter} onChange={(e) => setBranchFilter(e.target.value)}
                                    className="block w-full md:w-auto rounded-md border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 text-lg">
                                <option value="">--- ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤ ---</option>
                                {Object.keys(branchMap).map(id => (
                                    <option key={id} value={id}>{branchMap[id]}</option>
                                ))}
                            </select>

                            <button className="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg w-full md:w-auto transition duration-150 ease-in-out">
                                ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                            </button>
                        </div>
                        
                        {/* Status Indicator */}
                        <div className="mt-4 flex space-x-4 text-sm font-medium">
                            <span className="text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏™:</span>
                            <span className="text-indigo-600">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({filteredAndSortedCases.length})</span>
                            <span className="text-orange-600">‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ({pendingCount})</span>
                            <span className="text-green-600">‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß ({filteredAndSortedCases.length - pendingCount})</span>
                        </div>
                    </div>

                    {/* Case List Table */}
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider mobile-show">‡∏™‡∏≤‡∏Ç‡∏≤</th> 
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden lg:table-cell">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th>
                                        <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th className="px-6 py-4 whitespace-nowrap text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredAndSortedCases.length > 0 ? (
                                        filteredAndSortedCases.map(c => {
                                            const statusClass = c.status === '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' 
                                                ? 'bg-orange-100 text-orange-800' 
                                                : 'bg-green-100 text-green-800';

                                            return (
                                                <tr key={c.id} className="hover:bg-indigo-50/50 cursor-pointer">
                                                    <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">
                                                        {c.patient_name}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 mobile-show">{branchMap[c.branch] || '-'}</td> 
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{c.chief_complaints?.split(';')[0] || 'N/A'}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden lg:table-cell">{c.timestamp}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap">
                                                        <span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}`}>
                                                            {c.status}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <button onClick={() => onEditCase(c)} className="text-indigo-600 hover:text-indigo-900">‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                                    </td>
                                                </tr>
                                            );
                                        })
                                    ) : (
                                        <tr>
                                            <td colSpan="6" className="text-center p-8 text-gray-500">
                                                {!searchTerm && !branchFilter ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏™‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'}
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </main>
            );
        };

        // --- E. Main Application Component (App) ---
        function App() {
            const { db, userId, isAuthReady } = useFirebase();
            const { cases, loading } = useCaseData(db, isAuthReady);
            
            const [view, setView] = useState('dashboard');
            const [currentCase, setCurrentCase] = useState(null); 
            const [showPrintView, setShowPrintView] = useState(false); 
            const [isSaving, setIsSaving] = useState(false);
            
            // Check if config is present before rendering anything
             if (!isAuthReady && (!USER_FIREBASE_CONFIG.apiKey || USER_FIREBASE_CONFIG.apiKey === "YOUR_API_KEY")) {
                 return (
                     <div className="p-12 text-center bg-white m-12 rounded-lg shadow-xl font-kanit">
                        <h1 className="text-red-600 text-3xl font-bold">üõë Firebase Configuration Error</h1>
                        <p className="text-lg text-gray-700">
                            ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å **Firebase Configuration** ‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà
                        </p>
                    </div>
                 );
             }


            // Function to handle Firebase Save/Update
            const handleSave = async (caseData, isEdit, shouldPrint = false) => {
                if (!db || !userId) {
                    alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                    return;
                }

                setIsSaving(true);
                const caseCollectionRef = getCollectionCompat(db, 'artifacts', FIREBASE_PATH_APP_ID, 'public/data/cases');

                try {
                    let docId = caseData.id;
                    if (isEdit) {
                        // 1. UPDATE status in Firebase
                        const docRef = getDocCompat(db, 'artifacts', FIREBASE_PATH_APP_ID, 'public/data/cases', caseData.id);
                        const { id, timestamp, ...dataToUpdate } = caseData; 
                        await docRef.update(dataToUpdate);
                    } else {
                        // 1. ADD new case to Firebase
                        const newDocRef = await caseCollectionRef.add({
                            ...caseData,
                            timestamp: serverTimestampCompat(),
                            userId: userId, 
                        });
                        docId = newDocRef.id;
                    }
                    
                    if (shouldPrint) {
                        // 2. Trigger Apps Script Record/PDF (for Google Sheet update/Drive upload)
                        triggerAppsScriptRecord({ ...caseData, id: docId, status: '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß' }, isEdit);
                        
                        // 3. Show Print View immediately (Case Report)
                        const updatedCase = cases.find(c => c.id === docId) || { ...caseData, id: docId, timestamp: new Date().toLocaleDateString('th-TH') };
                        setCurrentCase(updatedCase);
                        setShowPrintView(true);

                    }
                    
                    if (!shouldPrint) { 
                        alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Ñ‡∏™ ${caseData.patient_name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                        setView('dashboard');
                        setCurrentCase(null);
                    }
                } catch (e) {
                    console.error("Error saving case to Firebase:", e);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console');
                } finally {
                    setIsSaving(false);
                }
            };
            
            // Function to handle Apps Script POST (For Record/PDF ONLY)
            const triggerAppsScriptRecord = async (caseData, isEdit) => {
                if (APPS_SCRIPT_RECORD_URL.includes('YOUR_DEPLOYED_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE')) {
                    console.warn('Apps Script URL not set. Skipping sheet recording.');
                    return;
                }
                
                try {
                    const caseDataForScript = { 
                        ...caseData, 
                        isEdit: isEdit 
                    }; 
                    
                    const response = await fetch(APPS_SCRIPT_RECORD_URL, {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(caseDataForScript)
                    });

                    if (!response.ok) throw new Error('Apps Script Server Error (HTTP ' + response.status + ')');
                    
                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.message || 'Apps Script reported an error.');
                    }

                } catch (e) {
                    console.error("Apps Script Record/PDF Error:", e);
                    // Show soft error using the new custom message
                    alert(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Firebase ‡πÅ‡∏•‡πâ‡∏ß ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô pdf ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô`);
                }
            };

            // --- Function to handle Referral/ADR submission (CORS-FREE) ---
            const handleReportSubmission = async (reportData, reportType) => {
                
                setIsSaving(false); // Do not show isSaving here, as it's just preparing the view
                
                try {
                    // 1. Prepare Print Data
                    const updatedReportData = { ...reportData, timestamp: new Date().toLocaleDateString('th-TH') };
                    setCurrentCase(updatedReportData); 
                    
                    // 2. Set view to show the Referral Print component (allow inspection)
                    setView('referral_print'); 

                } catch (e) {
                    console.error("Referral Report Error:", e);
                    alert(`‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ${reportType} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (${e.message})`);
                } 
                // Note: No finally block with setIsSaving(false) here, as we are staying on a view
            };
            
            // NEW: Function to handle final print and dashboard return from Referral Print View
            const handleReferralFinalize = () => {
                
                // 1. Trigger window.print()
                window.print();
                
                // 2. Optional: Trigger Apps Script submission/Firebase update if needed (Currently skipped, but here for future implementation)
                // if (APPS_SCRIPT_REFERRAL_URL && !APPS_SCRIPT_REFERRAL_URL.includes('YOUR_REFERRAL_APPS_SCRIPT_URL_HERE')) {
                //    // Trigger external submission here if necessary
                // }

                // 3. Finalize: Redirect to Dashboard and clear state
                alert(`‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏™‡∏ï‡πà‡∏≠‡πÑ‡∏õ`);
                setView('dashboard'); 
                setCurrentCase(null); 
            };
            
            const handleDelete = async (caseId) => {
                if (!db || !userId) return;

                try {
                    const docRef = getDocCompat(db, 'artifacts', FIREBASE_PATH_APP_ID, 'public/data/cases', caseId);
                    await docRef.delete();
                    alert('‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    setView('dashboard');
                    setCurrentCase(null);
                } catch (e) {
                    console.error("Error deleting case:", e);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™');
                }
            };
            
            if (!isAuthReady || !db || loading) {
                return <LoadingSpinner />;
            }

            let content;
            if (view === 'new_case' || view === 'edit_case') {
                content = (
                    <CaseForm 
                        initialCase={currentCase} 
                        onSave={handleSave} 
                        onCancel={() => { setView('dashboard'); setCurrentCase(null); }} 
                        onDelete={handleDelete}
                    />
                );
            } else if (view === 'referral_form') {
                 content = (
                    <ReferralForm 
                        initialData={currentCase} // Pass currentCase back to the form if editing
                        onCancel={() => {setView('dashboard'); setCurrentCase(null);}} 
                        onSendReport={handleReportSubmission}
                    />
                );
            } else if (view === 'referral_print' && currentCase) {
                // View for SPSR print preview - ADDED onEdit and onFinalize
                content = (
                    <ReferralPrintView 
                        caseData={currentCase} 
                        onEdit={() => setView('referral_form')} // Go back to the form
                        onFinalize={handleReferralFinalize} // Print and Finish
                    />
                );
            } else { // 'dashboard' view
                content = (
                    <Dashboard 
                        cases={cases} 
                        loading={loading} 
                        onAddCase={() => {setView('new_case'); setCurrentCase(null);}} 
                        onEditCase={(c) => { setCurrentCase(c); setView('edit_case'); }}
                        onReport={(type) => {
                             if(type === 'referral') setView('referral_form');
                             else alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ADR ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤ ‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
                        }}
                    />
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 font-kanit">
                    <header className="bg-white shadow-md sticky top-0 z-10 no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col justify-center items-center text-center">
                            <h1 className="text-3xl font-semibold text-gray-900 tracking-tight">
                                ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤ ‡∏°‡∏≠ ‡∏≠‡∏≠ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏£‡∏±‡∏á
                            </h1>
                            {/* REMOVED: ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á User ID ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠ */}
                        </div>
                    </header>
                    
                    {/* Main Content */}
                    {content}
                    
                    {/* Print View Component (shows up only when printing from CaseForm: onSave) */}
                    {showPrintView && currentCase && (
                        <StandardReportPrintView 
                            caseData={currentCase} 
                            onHide={() => setShowPrintView(false)} // Hiding controlled by useEffect
                            onPostPrint={() => { 
                                setShowPrintView(false); 
                                setView('dashboard'); 
                                setCurrentCase(null); 
                            }} 
                        />
                    )}

                    {/* Saving/Loading Overlay */}
                    {isSaving && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] no-print">
                            <div className="bg-white p-6 rounded-lg shadow-2xl flex items-center">
                                <LoadingSpinner />
                                <span className="ml-4 text-gray-700 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...</span>
                            </div>
                        </div>
                    )}
                    
                    {/* UPDATED: Footer Component */}
                    <Footer />

                </div>
            );
        }

        // --- ReactDOM Render ---
        const domContainer = document.getElementById('root');
        const root = ReactDOM.createRoot(domContainer);
        root.render(<App />);

        // ======================================================================
        // END of App.jsx Content
        // ======================================================================
    </script>
</body>
</html>
